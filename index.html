<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clintrades | Gold Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Josefin Sans', sans-serif;
            background-color: #0A0A0A;
            color: white;
            /* overflow: hidden; Removed to allow mobile scrolling */
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 140, 0, 0.3);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 140, 0, 0.8);
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .glass {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Modal Animation */
        #equityModal {
            transition: opacity 0.3s ease;
        }

        #equityModal.hidden {
            display: none;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#FF8C00', dark: '#0A0A0A', darker: '#000000', secondary: '#1A1A1A' }
                }
            }
        }

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failure', err));
            });
        }
    </script>
</head>

<body class="flex flex-col md:flex-row min-h-screen w-full md:h-screen md:overflow-hidden bg-dark">

    <!-- Sidebar (Form) -->
    <div
        class="w-full md:w-80 bg-secondary border-b md:border-b-0 md:border-r border-white/10 flex flex-col p-6 space-y-6 z-20 shadow-xl md:overflow-y-auto md:h-full shrink-0">
        <div class="flex items-center space-x-3">
            <div class="w-3 h-8 bg-primary rounded-full shadow-[0_0_15px_#FF8C00]"></div>
            <h1 class="text-2xl font-bold tracking-widest uppercase">Clintrades</h1>
        </div>

        <div class="space-y-6">
            <!-- Account -->
            <div class="space-y-3">
                <h3 class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Account</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500">Init Balance</label>
                        <input type="number" id="initBalance" value="10000"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Lot Size</label>
                        <input type="number" id="lotSize" value="0.10" step="0.01"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                </div>
            </div>

            <!-- Simulation Inputs -->
            <div class="space-y-3">
                <h3 class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Strategy</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="text-xs text-gray-500">MA Period</label>
                        <input type="number" id="maPeriod" value="1500"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">TP (pts)</label>
                        <input type="number" id="takeProfit" value="1000"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">SL (pts)</label>
                        <input type="number" id="stopLoss" value="500"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Trail Trig</label>
                        <input type="number" id="trailTrigger" value="200"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Trail Dist</label>
                        <input type="number" id="trailDist" value="100"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Max Entry</label>
                        <input type="number" id="maxEntry" value="50"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Spread</label>
                        <input type="number" id="spread" value="20"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Latency</label>
                        <input type="number" id="latency" value="0"
                            class="w-full bg-darker border border-white/10 rounded p-2 text-white outline-none">
                    </div>
                </div>
            </div>

            <button onclick="runSimulation()" id="runBtn"
                class="w-full bg-primary text-black font-bold py-3 rounded shadow-[0_0_15px_rgba(255,140,0,0.4)] hover:scale-105 transition transform active:scale-95">
                RUN SIMULATION
            </button>

            <!-- Status -->
            <div class="p-4 bg-primary/5 border border-primary/20 rounded-lg">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs text-primary font-bold">SYSTEM ACTIVE</span>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                </div>
                <p class="text-[10px] text-gray-500">Update: <span id="lastUpdate">Waiting...</span></p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex flex-col relative bg-dark md:flex-1 md:overflow-hidden min-h-0 w-full">
        <!-- Background Pattern -->
        <div
            class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 pointer-events-none">
        </div>

        <!-- Scrollable Container -->
        <div class="md:flex-1 md:overflow-y-auto custom-scrollbar p-6 space-y-6 z-10 w-full">

            <!-- KPI Cards (Stats) -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="glass p-5 rounded-xl hover:border-primary/50 transition duration-300">
                    <h4 class="text-gray-400 text-sm">Total Trades</h4>
                    <span id="totalTrades" class="text-3xl font-bold text-white">0</span>
                </div>
                <div class="glass p-5 rounded-xl hover:border-primary/50 transition duration-300">
                    <h4 class="text-gray-400 text-sm">Win Rate</h4>
                    <span id="winRate" class="text-3xl font-bold text-white">0%</span>
                </div>
                <div class="glass p-5 rounded-xl hover:border-primary/50 transition duration-300">
                    <h4 class="text-gray-400 text-sm">Profit Factor</h4>
                    <span id="profitFactor" class="text-3xl font-bold text-white">0.00</span>
                </div>
                <div class="glass p-5 rounded-xl hover:border-primary/50 transition duration-300">
                    <h4 class="text-gray-400 text-sm">Max DD</h4>
                    <span id="maxDrawdown" class="text-3xl font-bold text-red-500">$0.00</span>
                </div>
                <div class="glass p-5 rounded-xl hover:border-primary/50 transition duration-300">
                    <h4 class="text-gray-400 text-sm">Net Profit</h4>
                    <span id="netProfit" class="text-3xl font-bold text-gray-500">$0.00</span>
                </div>
            </div>

            <!-- Trade Log / Extras Area -->
            <div class="glass rounded-xl p-6 flex flex-col items-center justify-center space-y-4">
                <h3 class="text-lg font-semibold text-white/90">Detailed Analysis</h3>
                <div class="flex space-x-4">
                    <button onclick="toggleTradeLogModal()"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                        ðŸ“œ View Trade Log
                    </button>
                    <button onclick="toggleEquityModal()"
                        class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                        ðŸ“ˆ View Equity Curve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Log Modal -->
    <div id="tradeLogModal"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 md:p-10"
        onclick="if(event.target === this) toggleTradeLogModal()">
        <div
            class="bg-[#1A1A1A] w-full max-w-5xl h-[85vh] rounded-xl border border-white/10 flex flex-col relative shadow-2xl">
            <button onclick="toggleTradeLogModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="p-6 border-b border-white/10">
                <h2 class="text-xl font-bold text-white uppercase tracking-widest">Trade Log</h2>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3" id="modalTradeList">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Equity Curve Modal -->
    <div id="equityModal"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-10"
        onclick="if(event.target === this) toggleEquityModal()">
        <div
            class="bg-[#1A1A1A] w-full max-w-5xl h-[600px] rounded-xl border border-white/10 flex flex-col relative shadow-2xl">
            <button onclick="toggleEquityModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="p-6 border-b border-white/10">
                <h2 class="text-xl font-bold text-white uppercase tracking-widest">Equity Curve</h2>
            </div>
            <div class="flex-1 p-6">
                <div class="w-full h-full">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- Setup ---
        // Dynamic API URL for VPS/Localhost
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        let API_URL = isLocal ? "http://localhost:8000" : `http://${window.location.hostname}:8000`;

        // Manual Override via URL param ?api=x.x.x.x
        const urlParams = new URLSearchParams(window.location.search);
        const apiParam = urlParams.get('api');
        if (apiParam) API_URL = `http://${apiParam}:8000`; // HTTP for now

        console.log("Using API:", API_URL);

        setInterval(() => { document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString(); }, 1000);

        function toggleEquityModal() {
            document.getElementById('equityModal').classList.toggle('hidden');
        }

        function toggleTradeLogModal() {
            document.getElementById('tradeLogModal').classList.toggle('hidden');
        }

        // --- Chart ---
        const ctx = document.getElementById('equityChart').getContext('2d');
        const equityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Balance',
                    data: [],
                    borderColor: '#FF8C00',
                    backgroundColor: 'rgba(255, 140, 0, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { display: false } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }
                }
            }
        });

        // --- Simulation ---
        async function runSimulation() {
            const btn = document.getElementById('runBtn');
            const originalText = btn.innerText;
            btn.innerText = "RUNNING...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            // Params
            const params = {
                initial_balance: parseFloat(document.getElementById('initBalance').value),
                lot_size: parseFloat(document.getElementById('lotSize').value),
                ma_period: parseInt(document.getElementById('maPeriod').value),
                stop_loss_points: parseFloat(document.getElementById('stopLoss').value),
                take_profit_points: parseFloat(document.getElementById('takeProfit').value),
                trail_trigger_points: parseFloat(document.getElementById('trailTrigger').value),
                trail_dist_points: parseFloat(document.getElementById('trailDist').value),
                max_entry_dist_points: parseFloat(document.getElementById('maxEntry').value),
                latency_ms: parseInt(document.getElementById('latency').value),
                spread_points: parseFloat(document.getElementById('spread').value),
            };

            try {
                const res = await fetch(`${API_URL}/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                const data = await res.json();
                updateUI(data);
            } catch (e) {
                alert(`Error Fetching ${API_URL}\n${e.message}\n\nNote: If using VPS, add ?api=VPS_IP to URL.`);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        function updateUI(data) {
            // Stats
            document.getElementById('totalTrades').innerText = data.total_trades;
            document.getElementById('winRate').innerText = data.win_rate + "%";
            document.getElementById('profitFactor').innerText = data.profit_factor.toFixed(2);
            document.getElementById('maxDrawdown').innerText = "$" + data.max_drawdown.toFixed(2);

            const np = document.getElementById('netProfit');
            np.innerText = "$" + data.net_profit.toFixed(2);
            np.className = `text-3xl font-bold transition ${data.net_profit >= 0 ? 'text-green-500' : 'text-red-500'}`;

            // Chart
            equityChart.data.labels = data.equity_curve.map(d => d.time);
            equityChart.data.datasets[0].data = data.equity_curve.map(d => d.balance);
            equityChart.update();

            // Log (Populate Modal)
            const list = document.getElementById('modalTradeList');
            list.innerHTML = '';

            data.trades_log.slice().reverse().forEach(t => {
                const isWin = t.pnl > 0;
                // Card Style based on user reference
                const div = document.createElement('div');
                div.className = `bg-white/5 p-4 rounded border-l-4 ${isWin ? 'border-green-500' : 'border-red-500'} flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg transition-colors border-t border-r border-b border-white/5 hover:bg-white/10`;

                div.innerHTML = `
                   <div class="mb-2 md:mb-0 w-full md:w-auto">
                        <div class="flex items-center space-x-3 mb-2">
                             <span class="px-3 py-1 rounded font-bold text-xs uppercase ${t.type === 'BUY' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/50' : 'bg-orange-500/20 text-orange-400 border border-orange-500/50'} tracking-wide">
                                ${t.type} #${t.id}
                            </span>
                            <span class="text-xs text-gray-500 font-mono">${t.time_open}</span>
                        </div>
                         <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs font-mono text-gray-400 bg-black/20 p-2 rounded">
                            <div><span class="text-gray-600 block text-[10px] uppercase">Entry</span>${t.entry.toFixed(2)}</div>
                             <div><span class="text-gray-600 block text-[10px] uppercase">Exit</span>${t.exit.toFixed(2)}</div>
                             <div class="md:col-span-2 text-right md:text-left"><span class="text-gray-600 block text-[10px] uppercase">Outcome</span>${t.outcome}</div>
                        </div>
                   </div>
                   
                   <div class="text-right md:ml-6 min-w-[100px] mt-3 md:mt-0 pt-3 md:pt-0 border-t md:border-t-0 border-white/10 flex flex-col items-end w-full md:w-auto">
                        <div class="text-2xl font-bold ${isWin ? 'text-green-500' : 'text-red-500'}">${t.pnl >= 0 ? '+' : ''}${t.pnl.toFixed(2)}</div>
                   </div>
                `;
                list.appendChild(div);
            });
        }
    </script>
</body>

</html>
